<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caja con Asistente Aria - YAN'Z SMART WOOD</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1A202C">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto+Slab:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --yanz-bg: #FFFFFF; --yanz-bg-alt: #F7F8FC; --yanz-text: #2D3748;
            --yanz-text-alt: #718096; --yanz-heading: #1A202C; --yanz-primary: #0072CE;
            --yanz-border: #E2E8F0;
            --yanz-header-bg: #141821;
            --yanz-yellow: #facc15; 
        }

        html.dark {
            --yanz-bg: #1A202C; --yanz-bg-alt: #2D3748; --yanz-text: #E2E8F0;
            --yanz-text-alt: #A0AEC0; --yanz-heading: #FFFFFF; --yanz-primary: #38B2AC;
        }

        body {    
            font-family: 'Poppins', sans-serif;    
            background-color: var(--yanz-bg);
            color: var(--yanz-text);
        }

        h1, h2, h3, h4 {    
            font-family: 'Roboto Slab', serif;
            color: var(--yanz-heading);
        }

        #mobile-menu { background-color: var(--yanz-header-bg); }

        #cart-icon-wrapper {
            padding: 2px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.2);
            transition: border-color 0.3s ease-in-out;
        }
        #cart-icon-wrapper.has-items {
            border-color: var(--yanz-primary);
        }

        .chat-bubble-aria {
            background-color: var(--yanz-bg-alt);
            color: var(--yanz-text);
            animation: fadeIn 0.5s ease-out;
        }

        .chat-bubble-user {
            background-color: var(--yanz-primary);
            color: white;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #chat-window { scroll-behavior: smooth; }
    </style>
</head>
<body class="antialiased">

    <header id="main-header" class="bg-[var(--yanz-header-bg)] shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 sm:px-6 py-2 flex justify-between items-center">
            <a href="/index.html"><video autoplay loop muted playsinline class="h-12 w-auto"><source src="/assets/videos/videologo-header.mp4" type="video/mp4"></video></a>
            <div class="hidden md:flex items-center space-x-6 text-sm font-semibold">
                <a href="/index.html#productos" class="text-gray-300 hover:text-[var(--yanz-primary)] transition-colors">Productos</a>
                <a href="/index.html#servicios" class="text-gray-300 hover:text-[var(--yanz-primary)] transition-colors">Servicios</a>
                <a href="/index.html#juegos" class="text-gray-300 hover:text-[var(--yanz-primary)] transition-colors">Juegos</a>
                <a href="/index.html#contacto" class="text-gray-300 hover:text-[var(--yanz-primary)] transition-colors">Contacto</a>
            </div>
            <div class="flex items-center space-x-2">
                <div class="flex items-center space-x-3">
                    <div id="cart-icon-wrapper">
                        <button id="open-cart-button" class="relative p-1 rounded-full text-gray-300">
                            <video autoplay loop muted playsinline class="w-8 h-8"><source src="/assets/videos/video-carrito.mp4" type="video/mp4"></video>
                        </button>
                    </div>
                    <span id="cart-counter" class="text-2xl font-bold text-white hidden">0</span>
                </div>
                <button id="theme-toggle" class="p-2 rounded-full text-gray-300 hover:bg-gray-700">
                    <svg id="theme-icon-sun" class="h-6 w-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-1.414 8.486l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414-1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z"/></svg>
                    <svg id="theme-icon-moon" class="h-6 w-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                </button>
                <button class="ml-2 md:hidden text-gray-300 p-2" id="menu-button"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button>
            </div>
        </nav>
        <div id="mobile-menu" class="hidden md:hidden px-2 pt-2 pb-3 space-y-1 sm:px-3">
            <a href="/index.html#productos" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-300 hover:text-white hover:bg-gray-700">Productos</a>
            <a href="/index.html#servicios" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-300 hover:text-white hover:bg-gray-700">Servicios</a>
            <a href="/index.html#juegos" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-300 hover:text-white hover:bg-gray-700">Juegos</a>
            <a href="/index.html#contacto" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-300 hover:text-white hover:bg-gray-700">Contacto</a>
        </div>
    </header>

    <main>
        <section class="relative h-[60vh] flex items-center justify-center text-white bg-black">
            <video autoplay loop muted playsinline class="absolute inset-0 w-full h-full object-cover opacity-50">
                <source src="/assets/videos/aria.mp4" type="video/mp4" onerror="this.parentElement.style.backgroundColor = '#1A202C';">
            </video>
            <div class="relative z-10 text-center px-4">
                <h1 class="text-5xl md:text-7xl font-bold tracking-tight mb-4">Aria</h1>
                <p class="max-w-2xl mx-auto text-lg md:text-xl opacity-90">Tu asistente personal de compras. Finalicemos tu pedido.</p>
            </div>
        </section>

        <section class="bg-[var(--yanz-bg-alt)] py-12">
            <div id="voice-toggle-wrapper" class="max-w-3xl mx-auto mb-4 flex justify-end hidden">
                <button id="voice-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" title="Activar/Desactivar Voz">
                    <svg id="voice-on" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                    <svg id="voice-off" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 dark:text-gray-500 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l-2-2m0 0l-2-2m2 2l2 2m-2-2l2-2" /></svg>
                </button>
            </div>
            <div id="aria-checkout-container" class="max-w-3xl mx-auto bg-[var(--yanz-bg)] rounded-2xl shadow-xl overflow-hidden">
                <div id="chat-window" class="p-6 h-[70vh] overflow-y-auto space-y-6"></div>
                <div id="user-actions" class="p-4 border-t border-[var(--yanz-border)] bg-[var(--yanz-bg)]"></div>
            </div>
        </section>
    </main>

    <footer id="contacto" class="bg-gray-800 dark:bg-black text-gray-300 pt-16 pb-8">
        <div class="container mx-auto px-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-10 text-center md:text-left">
                <div><h3 class="text-2xl font-bold text-white mb-4">ContÃ¡ctanos</h3><p class="text-gray-400">Quito, Ecuador</p><p class="mt-2"><strong>Email:</strong> <a href="mailto:yanzsmartwood@gmail.com" class="text-teal-400 hover:underline">yanzsmartwood@gmail.com</a></p><p><strong>WhatsApp:</strong> <a href="https://wa.me/593996480843" target="_blank" class="text-teal-400 hover:underline">+593 99 648 0843</a></p></div>
                <div><h3 class="text-2xl font-bold text-white mb-4">SÃ­guenos</h3><div class="flex justify-center md:justify-start space-x-4"><a href="https://www.facebook.com/share/19jF7zJMsk/" target="_blank" class="transition-transform hover:scale-110"><img src="/assets/images/icono-facebook.png" alt="Facebook Logo" class="h-6 w-auto"></a><a href="https://www.tiktok.com/@yanz.smart.wood" target="_blank" class="transition-transform hover:scale-110"><img src="/assets/images/icono-tiktok.png" alt="TikTok Logo" class="h-6 w-auto"></a><a href="https://www.instagram.com/yanz_smart_wood" target="_blank" class="transition-transform hover:scale-110"><img src="/assets/images/icono-instagram.png" alt="Instagram Logo" class="h-6 w-auto"></a><a href="https://youtube.com/@yanzsmartwood" target="_blank" class="transition-transform hover:scale-110"><img src="/assets/images/icono-youtube.png" alt="YouTube Logo" class="h-6 w-auto"></a></div></div>
                <div><h3 class="text-2xl font-bold text-white mb-4">Formas de Pago</h3><div id="payment-logos" class="flex justify-center md:justify-start flex-wrap items-center gap-4 mb-2"></div><p class="text-xs text-gray-400">Coordina tu pago directamente con nosotros.</p></div>
            </div>
            <div class="border-t border-gray-700 py-6 mt-8 text-center text-xs text-gray-400">
                <p>&copy; <span id="year"></span> YAN'Z SMART WOOD. Todos los derechos reservados.</p>
                <div class="mt-4 space-x-4"><a href="/como-trabajamos.html" class="text-teal-400 hover:underline">CÃ³mo Trabajamos y Tiempos de Entrega</a><span class="text-gray-500">|</span><a href="/privacidad.html" class="text-teal-400 hover:underline">PolÃ­ticas de Privacidad</a><span class="text-gray-500">|</span><a href="/terminos.html" class="text-teal-400 hover:underline">TÃ©rminos de Servicio</a></div>
            </div>
        </div>
    </footer>
    
    <!-- BotÃ³n flotante de Turbo -->
    <button id="turbo-button" class="fixed bottom-6 left-6 z-40 rounded-full w-16 h-16 shadow-lg transition-transform hover:scale-110 flex items-center justify-center overflow-hidden" style="background-color: var(--yanz-yellow);">
        <video autoplay loop muted playsinline class="w-full h-full object-cover"><source src="/assets/videos/perrito_en_moto.mp4" type="video/mp4"></video>
    </button>
    <a href="https://wa.me/593996480843?text=Hola%2C%20estoy%20interesado%20en%20sus%20productos." class="fixed bottom-6 right-6 z-40 bg-green-500 rounded-full w-16 h-16 shadow-lg hover:bg-green-600 transition-transform hover:scale-110 flex items-center justify-center overflow-hidden" target="_blank"><video autoplay loop muted playsinline class="w-full h-full object-cover"><source src="/assets/videos/video-whatsapp.mp4" type="video/mp4"></video></a>

    <!-- Modales -->
    <div id="cart-modal" class="fixed inset-0 z-50 flex items-end sm:items-center sm:justify-end p-4 bg-black/70 backdrop-blur-sm hidden"></div>
    <div id="turbo-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm hidden"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- LÃ³gica del Encabezado ---
        const themeToggle = document.getElementById("theme-toggle");
        const sunIcon = document.getElementById("theme-icon-sun");
        const moonIcon = document.getElementById("theme-icon-moon");
        function applyTheme(theme) {
            document.documentElement.classList.toggle("dark", theme === "dark");
            if(sunIcon && moonIcon) {
                sunIcon.classList.toggle("hidden", theme !== 'dark');
                moonIcon.classList.toggle("hidden", theme === 'dark');
            }
        }
        themeToggle.addEventListener("click", () => {
            const newTheme = document.documentElement.classList.contains("dark") ? "light" : "dark";
            localStorage.setItem("theme", newTheme);
            applyTheme(newTheme);
        });
        const savedTheme = localStorage.getItem("theme") || "dark";
        applyTheme(savedTheme);

        const menuButton = document.getElementById("menu-button");
        const mobileMenu = document.getElementById("mobile-menu");
        if(menuButton && mobileMenu) {
            menuButton.addEventListener("click", () => mobileMenu.classList.toggle("hidden"));
        }
        
        // --- LÃ³gica del Pie de PÃ¡gina ---
        const paymentLogosContainer=document.getElementById("payment-logos");paymentLogosContainer&&[{name:"PeiGo",image:"/assets/images/pago-peigo.png"},{name:"Mastercard",image:"/assets/images/pago-mastercard.png"},{name:"Visa",image:"/assets/images/pago-visa.png"},{name:"American Express",image:"/assets/images/pago-american-express.png"},{name:"Discover",image:"/assets/images/pago-discover.png"},{name:"JCB",image:"/assets/images/pago-jcb.png"},{name:"Diners Club",image:"/assets/images/pago-diners-club.png"},{name:"PayPal",image:"/assets/images/pago-paypal.png"},{name:"Binance Pay",image:"/assets/images/pago-binance-pay.png"},{name:"Banco Guayaquil",image:"/assets/images/pago-banco-guayaquil.png"},{name:"Banco Pichincha",image:"/assets/images/pago-banco-pichincha.png"},{name:"DeUna",image:"/assets/images/pago-deuna.png"}].forEach(e=>{paymentLogosContainer.innerHTML+=`<img src="${e.image}" alt="${e.name}" title="${e.name}" class="h-8 bg-white rounded-md p-1">`});
        document.getElementById("year").textContent = new Date().getFullYear();

        // --- LÃ³gica del Carrito (unificada y funcional en esta pÃ¡gina) ---
        const cartModalContainer = document.getElementById('cart-modal');
        const openCartButton = document.getElementById('open-cart-button');
        const cartCounter = document.getElementById('cart-counter');
        const cartIconWrapper = document.getElementById('cart-icon-wrapper');

        // NUEVO: Funciones para manipular el carrito
        function getCart() {
            return JSON.parse(localStorage.getItem("yanz_cart")) || [];
        }

        function saveCart(cart) {
            localStorage.setItem("yanz_cart", JSON.stringify(cart));
            updateCartIcon();
            renderCartModal();
            // Si estamos en la pÃ¡gina del chat, actualizamos la conversaciÃ³n si estÃ¡ vacÃ­a
            if(window.location.pathname.includes('aria.html') && getCart().length === 0) {
                 initializePage();
            }
        }
        
        window.increaseQuantity = (itemName) => {
            let cart = getCart();
            const item = cart.find(i => i.name === itemName);
            if (item) {
                item.quantity++;
            }
            saveCart(cart);
        };

        window.decreaseQuantity = (itemName) => {
            let cart = getCart();
            const item = cart.find(i => i.name === itemName);
            if (item && item.quantity > 1) {
                item.quantity--;
            } else {
                // Si la cantidad es 1 o menos, eliminamos el item
                cart = cart.filter(i => i.name !== itemName);
            }
            saveCart(cart);
        };
        
        window.removeItemFromCart = (itemName) => {
            let cart = getCart().filter(i => i.name !== itemName);
            saveCart(cart);
        };


        // MODIFICADO: renderCartModal ahora es interactivo
        function renderCartModal() {
            const cart = getCart();
            const actionButtonHtml = cart.length > 0 
                ? `<a href="/aria.html" class="w-full inline-flex items-center justify-center gap-3 px-5 py-3 text-base font-semibold text-white bg-green-500 rounded-lg shadow-sm hover:bg-green-600 transition-all">
                    <span>Continuar con Aria</span>
                   </a>` 
                : '<a href="/ferreteria.html" class="w-full block text-center bg-[var(--yanz-primary)] text-white font-bold py-3 px-5 rounded-full">Volver a la tienda</a>';

            const cartItemsHtml = cart.length === 0 
                ? `<p class="text-gray-400 py-8 text-center">Tu carrito estÃ¡ vacÃ­o.</p>` 
                : cart.map(item => `
                    <div class="flex justify-between items-center py-3">
                        <span class="text-gray-300 pr-2 flex-grow">${item.name}</span>
                        <div class="flex items-center gap-2 text-white">
                            <button onclick="decreaseQuantity('${item.name}')" class="w-7 h-7 rounded-full bg-gray-600 hover:bg-gray-500 transition-colors">-</button>
                            <span class="w-8 text-center">${item.quantity}</span>
                            <button onclick="increaseQuantity('${item.name}')" class="w-7 h-7 rounded-full bg-gray-600 hover:bg-gray-500 transition-colors">+</button>
                            <button onclick="removeItemFromCart('${item.name}')" class="ml-2 text-red-400 hover:text-red-300 transition-colors" aria-label="Eliminar item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    </div>`).join("");

            cartModalContainer.innerHTML=`
                <div class="w-full max-w-md bg-[var(--yanz-header-bg)] rounded-2xl shadow-2xl p-6 flex flex-col modal-enter">
                    <div class="text-center mb-6">
                        <video autoplay loop muted playsinline class="w-24 h-24 mx-auto mb-2 rounded-full border-4 border-[var(--yanz-primary)] shadow-lg"><source src="/assets/videos/video-carrito.mp4" type="video/mp4"></video>
                        <h2 class="text-2xl font-bold text-white">Tu Carrito de Ideas</h2>
                    </div>
                    <div class="border-t border-gray-700 pt-4 flex-grow overflow-y-auto" style="max-height: 40vh;">
                        <div id="cart-items" class="divide-y divide-gray-700 text-left">${cartItemsHtml}</div>
                    </div>
                    <div class="mt-auto pt-4 space-y-3">
                        ${actionButtonHtml}
                        <button class="mt-2 text-sm text-gray-400 hover:text-white w-full" onclick="closeCartModal()">Cerrar</button>
                    </div>
                </div>`;
        }
        
        function updateCartIcon() {
            const cart = getCart();
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            if (cartCounter) {
                cartCounter.textContent = totalItems;
                cartCounter.classList.toggle('hidden', totalItems === 0);
            }
            if (cartIconWrapper) {
                cartIconWrapper.classList.toggle('has-items', totalItems > 0);
            }
        }

        window.closeCartModal = () => cartModalContainer.classList.add('hidden');
        openCartButton.addEventListener('click', () => {
            renderCartModal();
            cartModalContainer.classList.remove('hidden');
        });
        
        const turboModal = document.getElementById("turbo-modal");
        const openTurboButton = document.getElementById("turbo-button");
        function renderTurboModal(){
            turboModal.innerHTML = `<div class="w-full max-w-lg bg-[var(--yanz-header-bg)] rounded-2xl shadow-2xl p-6 flex flex-col text-center"><video autoplay loop muted playsinline class="w-32 h-32 mx-auto mb-4 rounded-full border-4 border-[var(--yanz-yellow)] shadow-lg object-cover"><source src="/assets/videos/perrito_en_moto.mp4" type="video/mp4"></video><h2 class="text-2xl font-bold text-white">Â¡Hola! Â¡Soy Turbo, listo para llevar tus materiales! ðŸš€</h2><div class="text-gray-300 text-sm mt-4 text-left space-y-4"><p>Mi misiÃ³n es entregarte todo lo que necesitas para tu proyecto de la manera mÃ¡s rÃ¡pida y clara posible. Â¡AquÃ­ te explico cÃ³mo funciono!</p><div><h4 class="font-bold text-white">Nota de Transparencia: Â¡Te lo consigo!</h4><p>Para darte el catÃ¡logo mÃ¡s completo, trabajo con los mejores proveedores. Si un artÃ­culo no estÃ¡ en nuestra bodega, me encargo de conseguirlo (usualmente en 48 horas). Siempre te contactaremos por WhatsApp para confirmar el tiempo exacto.</p></div><div><h4 class="font-bold text-white">Mis Tarifas de Entrega</h4><table class="w-full mt-2 text-xs md:text-sm"><thead class="border-b border-gray-600"><tr><th class="p-2">Zona</th><th class="p-2">Compra</th><th class="p-2">Costo</th></tr></thead><tbody><tr class="border-b border-gray-700"><td class="p-2">Quito Urbano</td><td class="p-2">Menor a $50</td><td class="p-2 font-bold">$4.00</td></tr><tr class="border-b border-gray-700"><td class="p-2">Quito Urbano</td><td class="p-2">$50 o mÃ¡s</td><td class="p-2 font-bold text-green-400">Â¡GRATIS!</td></tr><tr class="border-b border-gray-700"><td class="p-2">Valles</td><td class="p-2">Menor a $75</td><td class="p-2 font-bold">$7.00</td></tr><tr><td class="p-2">Valles</td><td class="p-2">$75 o mÃ¡s</td><td class="p-2 font-bold">$3.50</td></tr></tbody></table></div></div><div class="mt-6"><button class="w-full bg-[var(--yanz-yellow)] text-gray-900 font-bold py-3 px-5 rounded-lg shadow-sm hover:opacity-90 transition-opacity" onclick="closeTurboModal()">Â¡Entendido!</button></div></div>`;
        }
        window.closeTurboModal = () => turboModal.classList.add('hidden');
        openTurboButton.addEventListener('click', () => {
            renderTurboModal();
            turboModal.classList.remove('hidden');
        });

        // --- LÃ³gica del Chat de Aria ---
        const chatCart = getCart(); // Usamos la nueva funciÃ³n global
        const chatWindow = document.getElementById('chat-window');
        const userActions = document.getElementById('user-actions');
        const voiceToggleWrapper = document.getElementById('voice-toggle-wrapper');
        const voiceToggle = document.getElementById('voice-toggle');
        const voiceOnIcon = document.getElementById('voice-on');
        const voiceOffIcon = document.getElementById('voice-off');

        let isMuted = false;
        let conversationState = 'initial';
        let userData = { name: '', address: '', identification: '', email: '', notes: '' };

        const synth = window.speechSynthesis;
        let spanishVoice;
        
        function loadVoices() {
            const voices = synth.getVoices();
            spanishVoice = voices.find(voice => voice.lang.startsWith('es-')) || voices.find(voice => voice.lang.startsWith('es'));
        }
        loadVoices();
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = loadVoices;
        }

        // MODIFICADO: FunciÃ³n speak con limpieza de texto
        function speak(text) {
            synth.cancel(); 
            if (isMuted || !text) return;
            
            let plainText = text.replace(/<[^>]*>/g, ' '); 
            plainText = plainText.replace(/(\d+)\s*x\s+/gi, '$1 por ');
            plainText = plainText.replace(/&bull;/gi, '');
            plainText = plainText.replace(/â€¢/gi, '');

            const utterance = new SpeechSynthesisUtterance(plainText);
            if (spanishVoice) utterance.voice = spanishVoice;
            utterance.lang = 'es-ES';
            synth.speak(utterance);
        }
        
        voiceToggle.addEventListener('click', () => {
            isMuted = !isMuted;
            voiceOnIcon.classList.toggle('hidden', isMuted);
            voiceOffIcon.classList.toggle('hidden', !isMuted);
            if (isMuted) synth.cancel();
        });

        function addMessage(text, sender = 'aria', isHtml = false) {
            const wrapper = document.createElement('div');
            wrapper.className = `flex gap-3 items-end ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            let content = `<div class="w-fit max-w-full p-3 rounded-2xl chat-bubble-${sender === 'user' ? 'user' : 'aria'}">${isHtml ? text : text.replace(/\n/g, '<br>')}</div>`;
            wrapper.innerHTML = content;
            chatWindow.appendChild(wrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            if (sender === 'aria') speak(text);
        }

        function handleAction(action, value = null) {
            userActions.innerHTML = '<p class="text-center text-sm text-[var(--yanz-text-alt)]">Aria estÃ¡ escribiendo...</p>';
            synth.cancel();
            
            if (conversationState === 'start' && action === 'proceed') {
                addMessage('Â¡Perfecto!', 'user');
                setTimeout(askForName, 1000);
            } else if (conversationState === 'getting_name' && action === 'submit_name') {
                userData.name = value;
                addMessage(value, 'user');
                setTimeout(askForAddress, 1000);
            } else if (conversationState === 'getting_address' && action === 'submit_address') {
                userData.address = value;
                addMessage(value, 'user');
                setTimeout(askForIdentification, 1000); // Nuevo paso
            } else if (conversationState === 'getting_id' && action === 'submit_id') {
                userData.identification = value;
                addMessage(value, 'user');
                setTimeout(askForEmail, 1000); // Siguiente paso
            } else if (conversationState === 'getting_email' && action === 'submit_email') {
                userData.email = value;
                addMessage(value || 'Omitido', 'user');
                setTimeout(askForNotes, 1000);
            } else if (conversationState === 'getting_notes' && action === 'submit_notes') {
                userData.notes = value;
                addMessage(value || 'Sin notas', 'user');
                setTimeout(finalSummary, 1000);
            }
        }
        
        function askForName() {
            conversationState = 'getting_name';
            addMessage('Para comenzar, Â¿cuÃ¡l es tu nombre completo?');
            userActions.innerHTML = `<form onsubmit="event.preventDefault(); handleAction('submit_name', this.name.value);" class="flex items-center gap-2"><input type="text" name="name" required class="w-full flex-1 bg-[var(--yanz-bg-alt)] border border-[var(--yanz-border)] rounded-full py-3 px-5 focus:outline-none focus:ring-2 focus:ring-[var(--yanz-primary)] focus:border-transparent transition" placeholder="Escribe tu nombre..."><button type="submit" aria-label="Enviar" class="flex-shrink-0 bg-[var(--yanz-primary)] text-white rounded-full p-3 hover:bg-opacity-90 transition-all shadow-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7-7l7 7-7 7" /></svg></button></form>`;
            userActions.querySelector('input').focus();
        }

        function askForAddress() {
            conversationState = 'getting_address';
            addMessage(`Â¡Un gusto, ${userData.name}! Ahora, por favor, indÃ­came la direcciÃ³n completa para la entrega.`);
            userActions.innerHTML = `<form onsubmit="event.preventDefault(); handleAction('submit_address', this.address.value);" class="flex items-center gap-2"><input type="text" name="address" required class="w-full flex-1 bg-[var(--yanz-bg-alt)] border border-[var(--yanz-border)] rounded-full py-3 px-5 focus:outline-none focus:ring-2 focus:ring-[var(--yanz-primary)] focus:border-transparent transition" placeholder="Calle, nÃºmero, sector..."><button type="submit" aria-label="Enviar" class="flex-shrink-0 bg-[var(--yanz-primary)] text-white rounded-full p-3 hover:bg-opacity-90 transition-all shadow-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7-7l7 7-7 7" /></svg></button></form>`;
            userActions.querySelector('input').focus();
        }

        // NUEVA FUNCIÃ“N: Pedir CÃ©dula o RUC
        function askForIdentification() {
            conversationState = 'getting_id';
            addMessage('Gracias. Para la factura, por favor ingresa tu nÃºmero de CÃ©dula o RUC.');
            userActions.innerHTML = `<form onsubmit="event.preventDefault(); handleAction('submit_id', this.id.value);" class="flex items-center gap-2"><input type="text" name="id" required class="w-full flex-1 bg-[var(--yanz-bg-alt)] border border-[var(--yanz-border)] rounded-full py-3 px-5 focus:outline-none focus:ring-2 focus:ring-[var(--yanz-primary)] focus:border-transparent transition" placeholder="CÃ©dula o RUC..."><button type="submit" aria-label="Enviar" class="flex-shrink-0 bg-[var(--yanz-primary)] text-white rounded-full p-3 hover:bg-opacity-90 transition-all shadow-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7-7l7 7-7 7" /></svg></button></form>`;
            userActions.querySelector('input').focus();
        }

        function askForEmail() {
            conversationState = 'getting_email';
            addMessage('Â¡Casi listo! Si deseas una copia de la factura en tu correo, puedes escribirlo aquÃ­. Es opcional.');
            userActions.innerHTML = `<form onsubmit="event.preventDefault(); handleAction('submit_email', this.email.value);" class="flex items-center gap-2"><input type="email" name="email" class="w-full flex-1 bg-[var(--yanz-bg-alt)] border border-[var(--yanz-border)] rounded-full py-3 px-5 focus:outline-none focus:ring-2 focus:ring-[var(--yanz-primary)] focus:border-transparent transition" placeholder="tu.correo@ejemplo.com (opcional)"><button type="submit" aria-label="Enviar" class="flex-shrink-0 bg-[var(--yanz-primary)] text-white rounded-full p-3 hover:bg-opacity-90 transition-all shadow-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7-7l7 7-7 7" /></svg></button></form>`;
            userActions.querySelector('input').focus();
        }

        function askForNotes() {
            conversationState = 'getting_notes';
            addMessage('Perfecto. Â¿Hay alguna nota adicional que deba saber sobre tu pedido o la entrega?');
            userActions.innerHTML = `<form onsubmit="event.preventDefault(); handleAction('submit_notes', this.notes.value);" class="flex items-center gap-2"><input type="text" name="notes" class="w-full flex-1 bg-[var(--yanz-bg-alt)] border border-[var(--yanz-border)] rounded-full py-3 px-5 focus:outline-none focus:ring-2 focus:ring-[var(--yanz-primary)] focus:border-transparent transition" placeholder="Ej: llamar antes de llegar..."><button type="submit" aria-label="Enviar" class="flex-shrink-0 bg-[var(--yanz-primary)] text-white rounded-full p-3 hover:bg-opacity-90 transition-all shadow-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7-7l7 7-7 7" /></svg></button></form>`;
            userActions.querySelector('input').focus();
        }
        
        function finalSummary() {
            conversationState = 'final';
            const currentCart = getCart(); // Usamos la funciÃ³n global
            const saleItems = currentCart.filter(item => item.type === 'sale');
            const quoteItems = currentCart.filter(item => item.type === 'quote');
            
            let saleSubtotal = 0;
            if (saleItems.length > 0) {
                saleItems.forEach(item => saleSubtotal += (item.price * item.quantity));
            }
            
            const ivaRate = 0.15;
            const ivaAmount = saleSubtotal * ivaRate;
            const finalTotal = saleSubtotal + ivaAmount;

            const now = new Date();
            const options = {
                year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: true,
                timeZone: 'America/Guayaquil'
            };
            const formattedDateTime = now.toLocaleString('es-EC', options);

            let summaryMessage = 'Â¡Excelente! He procesado toda tu informaciÃ³n. Este es el resumen final:<br><br>';
            
            let whatsappMessage = `*Â¡Nuevo Pedido/CotizaciÃ³n desde la Web!* ðŸ¤–\n\n*Fecha del Pedido:* ${formattedDateTime}\n\n*-- DATOS DE FACTURACIÃ“N --*\n*Cliente:* ${userData.name}\n*CÃ©dula/RUC:* ${userData.identification}\n*DirecciÃ³n:* ${userData.address}\n`;
            if (userData.email) whatsappMessage += `*Email:* ${userData.email}\n`;
            if (userData.notes) whatsappMessage += `*Notas:* ${userData.notes}\n\n`;

            if (saleItems.length > 0) {
                summaryMessage += `<strong>Productos para Compra Inmediata:</strong><br>`;
                whatsappMessage += `\n*-- PRODUCTOS PARA COMPRA --*\n`;
                saleItems.forEach(item => {
                    summaryMessage += `&bull; ${item.quantity} x ${item.name}<br>`;
                    whatsappMessage += `- ${item.quantity} x ${item.name}\n`;
                });
                summaryMessage += `<br><div class='text-right'>`;
                summaryMessage += `<strong>Subtotal:</strong> $${saleSubtotal.toFixed(2)}<br>`;
                summaryMessage += `<strong>IVA (15%):</strong> $${ivaAmount.toFixed(2)}<br>`;
                summaryMessage += `<strong class='text-lg'>Total a Pagar: $${finalTotal.toFixed(2)}</strong><br><br>`;
                summaryMessage += `</div>`;

                whatsappMessage += `\n*Subtotal: $${saleSubtotal.toFixed(2)}*\n`;
                whatsappMessage += `*IVA (15%): $${ivaAmount.toFixed(2)}*\n`;
                whatsappMessage += `*Total a Pagar: $${finalTotal.toFixed(2)}*\n`;
            }

            if (quoteItems.length > 0) {
                summaryMessage += `<strong>Productos para CotizaciÃ³n:</strong><br>`;
                whatsappMessage += `\n*-- PRODUCTOS PARA COTIZAR --*\n`;
                quoteItems.forEach(item => {
                    summaryMessage += `&bull; ${item.quantity} x ${item.name}<br>`;
                    whatsappMessage += `- ${item.quantity} x ${item.name}\n`;
                });
            }

            summaryMessage += `<br>Para confirmar tu pedido y coordinar el pago, presiona el botÃ³n de WhatsApp.`;

            addMessage(summaryMessage, 'aria', true);
            const whatsappUrl = `https://wa.me/593996480843?text=${encodeURIComponent(whatsappMessage)}`;
            userActions.innerHTML = `<p class="text-center text-sm mb-4">Â¡Todo estÃ¡ listo! Presiona el botÃ³n para confirmar por WhatsApp.</p><a href="${whatsappUrl}" target="_blank" class="w-full block text-center bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-full transition-colors text-lg">Confirmar por WhatsApp</a>`;
        }

        function startConversation() {
            conversationState = 'start';
            voiceToggleWrapper.classList.remove('hidden');
            let cartSummary = 'Â¡Hola! Soy Aria, tu asistente de compras. He revisado tu carrito y tienes los siguientes productos:<br><br>';
            const currentCart = getCart();
            currentCart.forEach(item => {
                cartSummary += `&bull; ${item.quantity} x ${item.name} ${item.type === 'quote' ? '(para cotizar)' : ''}<br>`;
            });
            cartSummary += '<br>Â¿Es correcto? Podemos proceder a registrar tu pedido.';
            addMessage(cartSummary, 'aria', true);
            userActions.innerHTML = `<button onclick="handleAction('proceed')" class="w-full bg-[var(--yanz-primary)] text-white font-bold py-3 px-5 rounded-full">SÃ­, continuar</button>`;
        }

        function initializePage() {
             if (getCart().length === 0) {
                 addMessage('Â¡Hola! Soy Aria. Parece que tu carrito estÃ¡ vacÃ­o.');
                 userActions.innerHTML = '<a href="/ferreteria.html" class="w-full block text-center bg-[var(--yanz-primary)] text-white font-bold py-3 px-5 rounded-full">Volver a la tienda</a>';
                 return;
             }
            
             userActions.innerHTML = `
                 <button id="start-chat-btn" class="w-full bg-green-500 text-white font-bold py-4 px-6 rounded-full text-lg animate-pulse">
                     Hablar con Aria para comenzar
                 </button>
             `;
             document.getElementById('start-chat-btn').addEventListener('click', () => {
                 userActions.innerHTML = '<p class="text-center text-sm text-[var(--yanz-text-alt)]">Conectando...</p>';
                 setTimeout(startConversation, 500);
             }, { once: true });
        }
        
        window.handleAction = handleAction;

        updateCartIcon();
        // Solo inicializar el chat si estamos en la pÃ¡gina de aria
        if (document.getElementById('aria-checkout-container')) {
            initializePage();
        }
    });
    </script>
</body>
</html>
