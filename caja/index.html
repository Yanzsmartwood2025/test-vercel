<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caja con Asistente Aria - YAN'Z SMART WOOD</title>
    
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#1A202C">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto+Slab:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body class="antialiased">
    <div id="page-content">
        <header id="main-header" class="sticky top-0 left-0 right-0 z-40">
             <nav class="container mx-auto px-4 sm:px-6 py-2 flex justify-between items-center">
                 <a href="../index.html"><video autoplay loop muted playsinline class="h-12 w-auto"><source src="../assets/videos/videologo-header.mp4" type="video/mp4"></video></a>
                 <div class="hidden md:flex items-center space-x-6 text-sm font-semibold">
                     <a href="../#productos" class="text-gray-300 hover:text-[var(--yanz-primary)] transition-colors">Productos</a>
                     <a href="../#servicios" class="text-gray-300 hover:text-[var(--yanz-primary)] transition-colors">Servicios</a>
                     <a href="../#testimonios" class="text-gray-300 hover:text-[var(--yanz-primary)] transition-colors">Testimonios</a>
                     <a href="../#juegos" class="text-gray-300 hover:text-[var(--yanz-primary)] transition-colors">Juegos</a>
                     <a href="../caja/" class="text-gray-300 hover:text-[var(--yanz-primary)] transition-colors">Caja</a>
                     <a href="../#contacto" class="text-gray-300 hover:text-[var(--yanz-primary)] transition-colors">Contacto</a>
                 </div>
                 <div class="flex items-center space-x-2 sm:space-x-4">
                     <div id="auth-container" class="flex items-center"></div>
                     <div class="flex items-center space-x-3">
                          <div id="cart-icon-wrapper">
                              <button id="open-cart-button" class="relative p-1 rounded-full text-gray-300">
                                  <video autoplay loop muted playsinline class="w-8 h-8"><source src="../assets/videos/video-carrito.mp4" type="video/mp4"></video>
                              </button>
                          </div>
                          <span id="cart-counter" class="text-2xl font-bold text-white hidden">0</span>
                     </div>
                     <button id="theme-toggle" class="p-2 rounded-full text-gray-300 hover:bg-gray-700">
                         <svg id="theme-icon-sun" class="h-6 w-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-1.414 8.486l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414-1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z"/></svg>
                         <svg id="theme-icon-moon" class="h-6 w-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                     </button>
                     <button class="ml-2 md:hidden text-gray-300 p-2" id="menu-button"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button>
                 </div>
             </nav>
             <div id="mobile-menu" class="hidden md:hidden">
                 <a href="../#productos" class="mobile-nav-link block py-2 px-6 text-sm text-gray-300 hover:bg-gray-700">Productos</a><a href="../#servicios" class="mobile-nav-link block py-2 px-6 text-sm text-gray-300 hover:bg-gray-700">Servicios</a><a href="../#testimonios" class="mobile-nav-link block py-2 px-6 text-sm text-gray-300 hover:bg-gray-700">Testimonios</a><a href="../#juegos" class="mobile-nav-link block py-2 px-6 text-sm text-gray-300 hover:bg-gray-700">Juegos</a><a href="../caja/" class="mobile-nav-link block py-2 px-6 text-sm text-gray-300 hover:bg-gray-700">Caja</a><a href="../#contacto" class="mobile-nav-link block py-2 px-6 text-sm text-gray-300 hover:bg-gray-700">Contacto</a>
             </div>
        </header>

        <main>
            <section class="relative h-[60vh] flex items-center justify-center text-white bg-black">
                <video autoplay loop muted playsinline class="absolute inset-0 w-full h-full object-cover opacity-50">
                    <source src="../assets/videos/aria.mp4" type="video/mp4" onerror="this.parentElement.style.backgroundColor = '#1A202C';">
                </video>
                <div class="relative z-10 text-center px-4">
                    <h1 class="text-5xl md:text-7xl font-bold tracking-tight mb-4">Aria</h1>
                    <p class="max-w-2xl mx-auto text-lg md:text-xl opacity-90">Tu asistente personal de compras. Finalicemos tu pedido.</p>
                </div>
            </section>

            <section class="bg-[var(--yanz-bg-alt)] py-12">
                <div id="voice-toggle-wrapper" class="max-w-3xl mx-auto mb-4 flex justify-end hidden">
                    <button id="voice-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" title="Activar/Desactivar Voz">
                        <svg id="voice-on" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                        <svg id="voice-off" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 dark:text-gray-500 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l-2-2m0 0l-2-2m2 2l2 2m-2-2l2-2" /></svg>
                    </button>
                </div>
                <div id="aria-checkout-container" class="max-w-3xl mx-auto bg-[var(--yanz-bg)] rounded-2xl shadow-xl overflow-hidden">
                    <div id="chat-window" class="p-6 h-[70vh] overflow-y-auto space-y-6"></div>
                    <div id="user-actions" class="p-4 border-t border-[var(--yanz-border)] bg-[var(--yanz-bg)]"></div>
                </div>
            </section>
        </main>

        <footer id="contacto" class="bg-gray-800 dark:bg-black text-gray-300 pt-16 pb-8">
            <div class="container mx-auto px-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-10 text-center md:text-left">
                    <div><h3 class="text-2xl font-bold text-white mb-4">ContÃ¡ctanos</h3><p class="text-gray-400">Quito, Ecuador</p><p class="mt-2"><strong>Email:</strong> <a href="mailto:yanzsmartwood@gmail.com" class="text-teal-400 hover:underline">yanzsmartwood@gmail.com</a></p><p><strong>WhatsApp:</strong> <a href="https://wa.me/593996480843" target="_blank" class="text-teal-400 hover:underline">+593 99 648 0843</a></p></div>
                    <div><h3 class="text-2xl font-bold text-white mb-4">SÃ­guenos</h3><div class="flex justify-center md:justify-start space-x-4"><a href="https://www.facebook.com/share/19jF7zJMsk/" target="_blank" class="transition-transform hover:scale-110"><img src="../assets/images/iconos-sociales/icono-facebook.png" alt="Facebook Logo" class="h-6 w-auto"></a><a href="https://www.tiktok.com/@yanz.smart.wood" target="_blank" class="transition-transform hover:scale-110"><img src="../assets/images/iconos-sociales/icono-tiktok.png" alt="TikTok Logo" class="h-6 w-auto"></a><a href="https://www.instagram.com/yanz_smart_wood" target="_blank" class="transition-transform hover:scale-110"><img src="../assets/images/iconos-sociales/icono-instagram.png" alt="Instagram Logo" class="h-6 w-auto"></a><a href="https://youtube.com/@yanzsmartwood" target="_blank" class="transition-transform hover:scale-110"><img src="../assets/images/iconos-sociales/icono-youtube.png" alt="YouTube Logo" class="h-6 w-auto"></a></div></div>
                    <div><h3 class="text-2xl font-bold text-white mb-4">Formas de Pago</h3><div id="payment-logos" class="flex justify-center md:justify-start flex-wrap items-center gap-4 mb-2"></div><p class="text-xs text-gray-400">Coordina tu pago directamente con nosotros.</p></div>
                </div>
                <div class="border-t border-gray-700 py-6 mt-8 text-center text-xs text-gray-400">
                    <p>&copy; <span id="year"></span> YAN'Z SMART WOOD. Todos los derechos reservados.</p>
                    <div class="mt-4 space-x-4"><a href="../info/como-trabajamos.html" class="text-teal-400 hover:underline">CÃ³mo Trabajamos y Tiempos de Entrega</a><span class="text-gray-500">|</span><a href="../info/privacidad.html" class="text-teal-400 hover:underline">PolÃ­ticas de Privacidad</a><span class="text-gray-500">|</span><a href="../info/terminos.html" class="text-teal-400 hover:underline">TÃ©rminos de Servicio</a></div>
                </div>
            </div>
        </footer>
    </div>

    <a href="https://wa.me/593996480843?text=Hola%2C%20estoy%20interesado%20en%20sus%20productos." class="fixed bottom-6 right-6 z-50 transition-transform hover:scale-110" target="_blank">
        <img src="https://raw.githubusercontent.com/Yanzsmartwood2025/test-vercel/3f88d2114d6fa8db1eb71afb8b753dcf819785ae/assets/images/WhatsApp-logo2.png" alt="WhatsApp" class="w-14 h-14">
    </a>

    <div id="cart-modal" class="fixed inset-0 z-50 flex items-end sm:items-center sm:justify-end p-4 bg-black/70 backdrop-blur-sm hidden"></div>

    <div id="auth-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm hidden">
        <div class="w-full max-w-xs bg-[var(--yanz-header-bg)] rounded-2xl shadow-2xl p-8 flex flex-col modal-enter relative text-center">
             <button id="close-auth-modal-button" class="absolute top-3 right-3 text-gray-500 hover:text-white transition-colors">
                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
             </button>
            <h2 class="text-2xl font-bold text-white mb-2">Welcome</h2>
            <p class="text-gray-400 mb-6">Sign in or create an account</p>

            <button id="google-login-button-modal" class="w-full inline-flex items-center justify-center gap-3 px-4 py-2 text-base font-semibold text-gray-700 bg-white border border-transparent rounded-lg shadow-sm hover:bg-gray-200 transition-all">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C41.38,34.783,44,29.865,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                <span>Sign in with Google</span>
            </button>
        </div>
    </div>
    
    <!-- SDK de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

    <!-- Firebase Initializer (The Brain) -->
    <script src="../firebase-init.js"></script>

    <!-- Main Application Engine -->
    <script src="../js/main.js"></script>

    <!-- Page-specific logic for Aria Chat -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const chatWindow = document.getElementById('chat-window');
        const userActions = document.getElementById('user-actions');
        const voiceToggleWrapper = document.getElementById('voice-toggle-wrapper');
        const voiceToggle = document.getElementById('voice-toggle');
        const voiceOnIcon = document.getElementById('voice-on');
        const voiceOffIcon = document.getElementById('voice-off');

        if (!chatWindow) return; // Only run if we are on the checkout page

        let isMuted = false;
        let conversationState = 'initial';
        let userData = { name: '', address: '', identification: '', email: '', notes: '' };

        const synth = window.speechSynthesis;
        let spanishVoice;
        
        function loadVoices() {
            const voices = synth.getVoices();
            spanishVoice = voices.find(voice => voice.lang.startsWith('es-')) || voices.find(voice => voice.lang.startsWith('es'));
        }
        loadVoices();
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = loadVoices;
        }

        function speak(text) {
            synth.cancel(); 
            if (isMuted || !text) return;
            let plainText = text.replace(/<[^>]*>/g, ' ').replace(/&bull;/gi, '').replace(/â€¢/gi, '');
            const utterance = new SpeechSynthesisUtterance(plainText);
            if (spanishVoice) utterance.voice = spanishVoice;
            utterance.lang = 'es-ES';
            synth.speak(utterance);
        }
        
        voiceToggle.addEventListener('click', () => {
            isMuted = !isMuted;
            voiceOnIcon.classList.toggle('hidden', isMuted);
            voiceOffIcon.classList.toggle('hidden', !isMuted);
            if (isMuted) synth.cancel();
        });

        function addMessage(text, sender = 'aria', isHtml = false) {
            const wrapper = document.createElement('div');
            wrapper.className = `flex gap-3 items-end ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            let content = `<div class="w-fit max-w-full p-3 rounded-2xl chat-bubble-${sender === 'user' ? 'user' : 'aria'}">${isHtml ? text : text.replace(/\n/g, '<br>')}</div>`;
            wrapper.innerHTML = content;
            chatWindow.appendChild(wrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            if (sender === 'aria') speak(text);
        }

        function handleAction(action, value = null) {
            userActions.innerHTML = '<p class="text-center text-sm text-[var(--yanz-text-alt)]">Aria estÃ¡ escribiendo...</p>';
            synth.cancel();
            
            if (conversationState === 'start' && action === 'proceed') {
                addMessage('Â¡Perfecto!', 'user');
                setTimeout(askForName, 1000);
            } else if (conversationState === 'getting_name' && action === 'submit_name') {
                userData.name = value;
                addMessage(value, 'user');
                setTimeout(askForAddress, 1000);
            } else if (conversationState === 'getting_address' && action === 'submit_address') {
                userData.address = value;
                addMessage(value, 'user');
                setTimeout(askForIdentification, 1000);
            } else if (conversationState === 'getting_id' && action === 'submit_id') {
                userData.identification = value;
                addMessage(value, 'user');
                setTimeout(askForEmail, 1000);
            } else if (conversationState === 'getting_email' && action === 'submit_email') {
                userData.email = value;
                addMessage(value || 'Omitido', 'user');
                setTimeout(askForNotes, 1000);
            } else if (conversationState === 'getting_notes' && action === 'submit_notes') {
                userData.notes = value;
                addMessage(value || 'Sin notas', 'user');
                setTimeout(finalSummary, 1000);
            }
        }
        
        function askForName() {
            conversationState = 'getting_name';
            addMessage('Para comenzar, Â¿cuÃ¡l es tu nombre completo?');
            userActions.innerHTML = `<form onsubmit="event.preventDefault(); handleAction('submit_name', this.name.value);" class="flex items-center gap-2"><input type="text" name="name" required class="w-full flex-1 bg-[var(--yanz-bg-alt)] border border-[var(--yanz-border)] rounded-full py-3 px-5 focus:outline-none focus:ring-2 focus:ring-[var(--yanz-primary)] focus:border-transparent transition" placeholder="Escribe tu nombre..."><button type="submit" aria-label="Enviar" class="flex-shrink-0 bg-[var(--yanz-primary)] text-white rounded-full p-3 hover:bg-opacity-90 transition-all shadow-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7-7l7 7-7 7" /></svg></button></form>`;
            userActions.querySelector('input').focus();
        }

        function askForAddress() {
            conversationState = 'getting_address';
            addMessage('Â¡Un gusto, ' + userData.name + '! Ahora, por favor, indÃ­came la direcciÃ³n completa para la entrega.');
            userActions.innerHTML = `<form onsubmit="event.preventDefault(); handleAction('submit_address', this.address.value);" class="flex items-center gap-2"><input type="text" name="address" required class="w-full flex-1 bg-[var(--yanz-bg-alt)] border border-[var(--yanz-border)] rounded-full py-3 px-5 focus:outline-none focus:ring-2 focus:ring-[var(--yanz-primary)] focus:border-transparent transition" placeholder="Calle, nÃºmero, sector..."><button type="submit" aria-label="Enviar" class="flex-shrink-0 bg-[var(--yanz-primary)] text-white rounded-full p-3 hover:bg-opacity-90 transition-all shadow-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7-7l7 7-7 7" /></svg></button></form>`;
            userActions.querySelector('input').focus();
        }

        function askForIdentification() {
            conversationState = 'getting_id';
            addMessage('Gracias. Para la factura, por favor ingresa tu nÃºmero de CÃ©dula o RUC.');
            userActions.innerHTML = `<form onsubmit="event.preventDefault(); handleAction('submit_id', this.id.value);" class="flex items-center gap-2"><input type="text" name="id" required class="w-full flex-1 bg-[var(--yanz-bg-alt)] border border-[var(--yanz-border)] rounded-full py-3 px-5 focus:outline-none focus:ring-2 focus:ring-[var(--yanz-primary)] focus:border-transparent transition" placeholder="CÃ©dula o RUC..."><button type="submit" aria-label="Enviar" class="flex-shrink-0 bg-[var(--yanz-primary)] text-white rounded-full p-3 hover:bg-opacity-90 transition-all shadow-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7-7l7 7-7 7" /></svg></button></form>`;
            userActions.querySelector('input').focus();
        }

        function askForEmail() {
            conversationState = 'getting_email';
            addMessage('Â¡Casi listo! Si deseas una copia de la factura en tu correo, puedes escribirlo aquÃ­. Es opcional.');
            userActions.innerHTML = `<form onsubmit="event.preventDefault(); handleAction('submit_email', this.email.value);" class="flex items-center gap-2"><input type="email" name="email" class="w-full flex-1 bg-[var(--yanz-bg-alt)] border border-[var(--yanz-border)] rounded-full py-3 px-5 focus:outline-none focus:ring-2 focus:ring-[var(--yanz-primary)] focus:border-transparent transition" placeholder="tu.correo@ejemplo.com (opcional)"><button type="submit" aria-label="Enviar" class="flex-shrink-0 bg-[var(--yanz-primary)] text-white rounded-full p-3 hover:bg-opacity-90 transition-all shadow-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7-7l7 7-7 7" /></svg></button></form>`;
            userActions.querySelector('input').focus();
        }

        function askForNotes() {
            conversationState = 'getting_notes';
            addMessage('Perfecto. Â¿Hay alguna nota adicional que deba saber sobre tu pedido o la entrega?');
            userActions.innerHTML = `<form onsubmit="event.preventDefault(); handleAction('submit_notes', this.notes.value);" class="flex items-center gap-2"><input type="text" name="notes" class="w-full flex-1 bg-[var(--yanz-bg-alt)] border border-[var(--yanz-border)] rounded-full py-3 px-5 focus:outline-none focus:ring-2 focus:ring-[var(--yanz-primary)] focus:border-transparent transition" placeholder="Ej: llamar antes de llegar..."><button type="submit" aria-label="Enviar" class="flex-shrink-0 bg-[var(--yanz-primary)] text-white rounded-full p-3 hover:bg-opacity-90 transition-all shadow-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7-7l7 7-7 7" /></svg></button></form>`;
            userActions.querySelector('input').focus();
        }
        
        function finalSummary() {
            conversationState = 'final';
            const currentCart = window.getCart(); // Uses global getCart
            const saleItems = currentCart.filter(item => item.type === 'sale');
            const quoteItems = currentCart.filter(item => item.type === 'quote');
            let saleSubtotal = saleItems.reduce((total, item) => total + (item.price * item.quantity), 0);
            const ivaRate = 0.15;
            const ivaAmount = saleSubtotal * ivaRate;
            const finalTotal = saleSubtotal + ivaAmount;
            const formattedDateTime = new Date().toLocaleString('es-EC', { timeZone: 'America/Guayaquil' });

            let summaryMessage = 'Â¡Excelente! He procesado toda tu informaciÃ³n. Este es el resumen final:<br><br>';
            let whatsappMessage = `*Â¡Nuevo Pedido/CotizaciÃ³n desde la Web!* ðŸ¤–\n\n*Fecha:* ${formattedDateTime}\n\n*-- DATOS --*\n*Cliente:* ${userData.name}\n*CÃ©dula/RUC:* ${userData.identification}\n*DirecciÃ³n:* ${userData.address}\n`;
            if (userData.email) whatsappMessage += `*Email:* ${userData.email}\n`;
            if (userData.notes) whatsappMessage += `*Notas:* ${userData.notes}\n`;

            if (saleItems.length > 0) {
                summaryMessage += `<strong>Productos para Compra:</strong><br>`;
                whatsappMessage += `\n*-- COMPRA --*\n`;
                saleItems.forEach(item => { summaryMessage += `&bull; ${item.quantity} x ${item.name}<br>`; whatsappMessage += `- ${item.quantity} x ${item.name}\n`; });
                summaryMessage += `<br><div class='text-right'><strong>Subtotal:</strong> $${saleSubtotal.toFixed(2)}<br><strong>IVA (15%):</strong> $${ivaAmount.toFixed(2)}<br><strong class='text-lg'>Total: $${finalTotal.toFixed(2)}</strong></div><br>`;
                whatsappMessage += `\n*Total a Pagar: $${finalTotal.toFixed(2)}*\n`;
            }
            if (quoteItems.length > 0) {
                summaryMessage += `<strong>Productos para CotizaciÃ³n:</strong><br>`;
                whatsappMessage += `\n*-- COTIZACIÃ“N --*\n`;
                quoteItems.forEach(item => { summaryMessage += `&bull; ${item.quantity} x ${item.name}<br>`; whatsappMessage += `- ${item.quantity} x ${item.name}\n`; });
            }
            summaryMessage += `<br>Para confirmar, presiona el botÃ³n de WhatsApp.`;
            addMessage(summaryMessage, 'aria', true);
            const whatsappUrl = `https://wa.me/593996480843?text=${encodeURIComponent(whatsappMessage)}`;
            userActions.innerHTML = `<p class="text-center text-sm mb-4">Â¡Todo listo! Presiona para confirmar por WhatsApp.</p><a href="${whatsappUrl}" target="_blank" class="w-full block text-center bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-full transition-colors text-lg">Confirmar por WhatsApp</a>`;
        }

        function startConversation() {
            conversationState = 'start';
            voiceToggleWrapper.classList.remove('hidden');
            const currentCart = window.getCart(); // Use global getCart
            let cartSummary = 'Â¡Hola! Soy Aria. He revisado tu carrito y tienes:<br><br>';
            currentCart.forEach(item => { cartSummary += `&bull; ${item.quantity} x ${item.name}<br>`; });
            cartSummary += '<br>Â¿Es correcto para iniciar tu pedido?';
            addMessage(cartSummary, 'aria', true);
            userActions.innerHTML = `<button onclick="handleAction('proceed')" class="w-full bg-[var(--yanz-primary)] text-white font-bold py-3 px-5 rounded-full">SÃ­, continuar</button>`;
        }

        function initializePage() {
             if (window.getCart().length === 0) { // Use global getCart
                 addMessage('Â¡Hola! Soy Aria. Tu carrito estÃ¡ vacÃ­o.');
                 userActions.innerHTML = '<a href="../ferreteria/" class="w-full block text-center bg-[var(--yanz-primary)] text-white font-bold py-3 px-5 rounded-full">Explorar Productos</a>';
                 return;
             }
             userActions.innerHTML = `<button id="start-chat-btn" class="w-full bg-green-500 text-white font-bold py-4 px-6 rounded-full text-lg animate-pulse">Hablar con Aria para comenzar</button>`;
             document.getElementById('start-chat-btn').addEventListener('click', () => {
                 userActions.innerHTML = '<p class="text-center text-sm text-[var(--yanz-text-alt)]">Conectando...</p>';
                 setTimeout(startConversation, 500);
             }, { once: true });
        }
        
        window.handleAction = handleAction;
        initializePage();
    });
    </script>
</body>
</html>
